services:
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: clock-mosquitto
    ports:
      - "1883:1883"
    volumes:
      - ./deploy/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_pub -h 127.0.0.1 -p 1883 -t __health -m ok >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: clock-server
    depends_on:
      mosquitto:
        condition: service_healthy
    environment:
      HTTP_ADDR: ":8080"
      REQUIRE_TLS: "false"
      TRUST_PROXY_TLS: "false"
      READINESS_REQUIRE_AUTH: "false"
      API_AUTH_CREDENTIALS: "ops|dev-token|*"
      ENABLED_SENDERS: "mqtt"
      MQTT_BROKER_URL: "mqtt://mosquitto:1883"
      ALLOW_INSECURE_MQTT: "true"
      MQTT_TOPIC_PREFIX: "clocks/commands"
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 10

  clockctl:
    image: golang:1.24-alpine
    container_name: clockctl
    working_dir: /workspace
    volumes:
      - .:/workspace
    environment:
      CLOCK_SERVER_HOST: "http://server:8080"
      CLOCK_SERVER_TOKEN: "dev-token"
      CLOCKCTL_ALLOW_INSECURE_HTTP: "true"
    depends_on:
      server:
        condition: service_healthy
    entrypoint: ["go", "run", "./cmd/clockctl"]
    command: ["message", "--device", "clock-1", "--message", "compose-test", "--duration", "10"]

networks:
  default:
    name: clock-server-net
